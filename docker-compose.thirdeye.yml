#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

version: '3'
services:
  thirdeye_mysql:
    image: mysql:5.7
    ports:
      - 33306:3306
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_USER: thirdeye
      MYSQL_PASSWORD: thirdeye
    volumes:
      - ./thirdeye/configs/schema/create-schema.sql:/docker-entrypoint-initdb.d/init.sql
  thirdeye_frontend:
    image: razorpay/thirdeye
    volumes:
      - ./thirdeye/thirdeye-dashboard/config/persistence.yml:/opt/thirdeye/config/default/persistence.yml
      - ./thirdeye/thirdeye-dashboard/config/data-sources/data-sources-config.yml:/opt/thirdeye/config/default/data-sources/data-sources-config.yml
      - ./thirdeye/thirdeye-dashboard/config/detector.yml:/opt/thirdeye/config/default/detector.yml
      - ./thirdeye/configs/others/jmx_config.yml:/opt/thirdeye/config/default/jmx_config.yml
      - ./dockerconf/entrypoint_dev.sh:/opt/thirdeye/bin/entrypoint_dev.sh
      - ./thirdeye/thirdeye-dashboard/config/rca.yml:/opt/thirdeye/config/default/rca.yml
      - ./thirdeye/thirdeye-dashboard/config/dashboard.yml:/opt/thirdeye/config/default/dashboard.yml
      # - ./thirdeye/thirdeye-frontend/config/environment.js:/opt/thirdeye/thirdeye-frontend/config/default/environment.js
      #- ./thirdeye/thirdeye-pinot/config-templates/cloud/persistence.yml.tmpl:/opt/thirdeye/config/default/persistence.yml.tmpl
      #- ./thirdeye/thirdeye-pinot/config-templates/cloud/data-sources/data-sources-config.yml.tmpl:/opt/thirdeye/config/default/data-sources/data-sources-config.yml.tmpl
      #- ./dockerconf/entrypoint.sh:/opt/thirdeye/bin/entrypoint.sh
      #- ./thirdeye/thirdeye-pinot/config-templates/dev/persistence.yml:/opt/thirdeye/config/default/persistence.yml
      #- ./thirdeye/thirdeye-pinot/config-templates/dev/data-sources/data-sources-config.yml:/opt/thirdeye/config/default/data-sources/data-sources-config.yml
    environment:
      CONFIG_DIR: /opt/thirdeye/config/default
      FE_CONFIG_DIR: /opt/thirdeye/thirdeye-frontend/config/default
      MYSQL_HOSTNAME: ${MYSQL_HOSTNAME}
      MYSQL_PORT: ${MYSQL_PORT}
      THIRDEYE_DATABASE: ${THIRDEYE_DATABASE}
      MYSQL_USERNAME: ${MYSQL_USERNAME}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      DRUID_USERNAME: ${DRUID_USERNAME}
      DRUID_PASSWORD: ${DRUID_PASSWORD}
      POSTGRES_HOSTNAME: ${POSTGRES_HOSTNAME}
      POSTGRES_PORT: ${POSTGRES_PORT}
      THIRDEYE_POSTGRES_DATABASE: ${THIRDEYE_POSTGRES_DATABASE}
      THIRDEYE_POSTGRES_USER: ${THIRDEYE_POSTGRES_USER}
      THIRDEYE_POSTGRES_PASSWORD: ${THIRDEYE_POSTGRES_PASSWORD}
      APP_MODE: prod
      JMX_CONFIG: "-Xms1G -Xmx3G"
      SLACK_TOKEN: ${SLACK_TOKEN}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_AUTH_REDIRECT_URL: ${GOOGLE_AUTH_REDIRECT_URL}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
    ports:
      - 1426:1426
      - 1427:1427
      - 8080:8080
    entrypoint: ["/bin/sh", "/opt/thirdeye/bin/entrypoint_dev.sh", "frontend"]
    #entrypoint: ["/bin/sh", "/opt/thirdeye/bin/entrypoint.sh", "frontend"]
    #entrypoint: ["sleep", "3600"]
    depends_on:
      - thirdeye_mysql
    links:
      - thirdeye_mysql
  thirdeye_backend:
    image: razorpay/thirdeye
    volumes:
      - ./thirdeye/thirdeye-dashboard/config/persistence.yml:/opt/thirdeye/config/default/persistence.yml
      - ./thirdeye/thirdeye-dashboard/config/data-sources/data-sources-config.yml:/opt/thirdeye/config/default/data-sources/data-sources-config.yml
      - ./thirdeye/thirdeye-dashboard/config/detector.yml:/opt/thirdeye/config/default/detector.yml
      - ./thirdeye/configs/others/jmx_config.yml:/opt/thirdeye/config/default/jmx_config.yml
      - ./dockerconf/entrypoint_dev.sh:/opt/thirdeye/bin/entrypoint_dev.sh
      - ./thirdeye/thirdeye-dashboard/config/rca.yml:/opt/thirdeye/config/default/rca.yml
      - ./thirdeye/thirdeye-dashboard/config/dashboard.yml:/opt/thirdeye/config/default/dashboard.yml
      # - ./thirdeye/thirdeye-frontend/config/environment.js:/opt/thirdeye/thirdeye-frontend/config/default/environment.js
      #- ./thirdeye/thirdeye-pinot/config-templates/cloud/persistence.yml.tmpl:/opt/thirdeye/config/default/persistence.yml.tmpl
      #- ./thirdeye/thirdeye-pinot/config-templates/cloud/data-sources/data-sources-config.yml.tmpl:/opt/thirdeye/config/default/data-sources/data-sources-config.yml.tmpl
      #- ./dockerconf/entrypoint.sh:/opt/thirdeye/bin/entrypoint.sh
      #- ./thirdeye/thirdeye-pinot/config-templates/dev/persistence.yml:/opt/thirdeye/config/default/persistence.yml
      #- ./thirdeye/thirdeye-pinot/config-templates/dev/data-sources/data-sources-config.yml:/opt/thirdeye/config/default/data-sources/data-sources-config.yml
    ports:
      - 8081:8080
    environment:
      CONFIG_DIR: /opt/thirdeye/config/default
      FE_CONFIG_DIR: /opt/thirdeye/thirdeye-frontend/config/default
      MYSQL_HOSTNAME: ${MYSQL_HOSTNAME}
      MYSQL_PORT: ${MYSQL_PORT}
      THIRDEYE_DATABASE: ${THIRDEYE_DATABASE}
      MYSQL_USERNAME: ${MYSQL_USERNAME}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      DRUID_USERNAME: ${DRUID_USERNAME}
      DRUID_PASSWORD: ${DRUID_PASSWORD}
      POSTGRES_HOSTNAME: ${POSTGRES_HOSTNAME}
      POSTGRES_PORT: ${POSTGRES_PORT}
      THIRDEYE_POSTGRES_DATABASE: ${THIRDEYE_POSTGRES_DATABASE}
      THIRDEYE_POSTGRES_USER: ${THIRDEYE_POSTGRES_USER}
      THIRDEYE_POSTGRES_PASSWORD: ${THIRDEYE_POSTGRES_PASSWORD}
      APP_MODE: prod
      JMX_CONFIG: "-Xms1G -Xmx3G"
      SLACK_TOKEN: ${SLACK_TOKEN}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_AUTH_REDIRECT_URL: ${GOOGLE_AUTH_REDIRECT_URL}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
    entrypoint: ["/bin/sh", "/opt/thirdeye/bin/entrypoint_dev.sh", "backend"]
    #entrypoint: ["/bin/sh", "/opt/thirdeye/bin/entrypoint.sh", "backend"]
    depends_on:
      - thirdeye_mysql
    links:
      - thirdeye_mysql
